<!doctype html><html lang=en-us dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to verify that ILogger logged an error? | Mart's blog</title><meta name=keywords content="Azure,Application Insights,Monitoring,Xunit,FakeItEasy"><meta name=description content="Explains how to test LogError with Xunit."><meta name=author content="Mart de Graaf"><link rel=canonical href=https://martdegraaf.github.io/posts/verifylogged-with-xunit/><link crossorigin=anonymous href=/assets/css/stylesheet.a2b9293ea8fe88eef313a170e50df6eb956352a2478e56176241422d311b280f.css integrity="sha256-orkpPqj+iO7zE6Fw5Q3265VjUqJHjlYXYkFCLTEbKA8=" rel="preload stylesheet" as=style><link rel=icon href=https://martdegraaf.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://martdegraaf.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://martdegraaf.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://martdegraaf.github.io/apple-touch-icon.png><link rel=mask-icon href=https://martdegraaf.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://martdegraaf.github.io/posts/verifylogged-with-xunit/index.xml><link rel=alternate hreflang=en-us href=https://martdegraaf.github.io/posts/verifylogged-with-xunit/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=text/javascript>!function(e,t,n){var s,o=e.location,f="script",m="connectionString",a="ingestionendpoint",d="disableExceptionTracking",l="ai.device.",c="toLowerCase",r="crossOrigin",u="POST",h="appInsightsSDK",i=n.name||"appInsights";(n.name||e[h])&&(e[h]=i),s=e[i]||function(s){var p,g,v,j,C,k=!1,b=!1,i={initialize:!0,queue:[],sv:"5",version:2,config:s};function y(e,t){var n={},s="Browser";return n[l+"id"]=s[c](),n[l+"type"]=s,n["ai.operation.name"]=o&&o.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(i.sv||i.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}if(g=s.url||n.src,g){function E(){var r,l,d,h,f,p,v,j,_,w,O;k=!0,i.queue=[],b||(b=!0,l=g,h=function(){var t,n,o,i,r,e={},l=s.connectionString;if(l)for(o=l.split(";"),t=0;t<o.length;t++)n=o[t].split("="),2===n.length&&(e[n[0][c]()]=n[1]);return e[a]||(i=e.endpointsuffix,r=i?e.location:null,e[a]="https://"+(r?r+".":"")+"dc."+(i||"services.visualstudio.com")),e}(),f=h[m]||s[m]||"",p=h[a],r=p?p+"/v2/track":s.endpointUrl,(v=[]).push((d="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",j=l,_=r,(O=(w=y(f,"Exception")).data).baseType="ExceptionData",O.baseData.exceptions=[{typeName:"SDKLoadFailed",message:d.replace(/\./g,"-"),hasFullStack:!1,stack:d+`
Snippet failed to load [`+j+`] -- Telemetry is disabled
Help Link: https://go.microsoft.com/fwlink/?linkid=2128109
Host: `+(o&&o.pathname||"_unknown_")+`
Endpoint: `+_,parsedStack:[]}],w)),v.push(function(e,t,n,s){var o,i=y(f,"Message"),a=i.data;return a.baseType="MessageData",o=a.baseData,o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/"/g,"")+'"',o.properties={endpoint:s},i}(0,0,l,r)),function(t,s){if(JSON){var o,i=e.fetch;i&&!n.useXhr?i(s,{method:u,body:JSON.stringify(t),mode:"cors"}):XMLHttpRequest&&(o=new XMLHttpRequest,o.open(u,s),o.setRequestHeader("Content-type","application/json"),o.send(JSON.stringify(t)))}}(v,r))}function w(e,t){b||setTimeout(function(){!t&&i.core||E()},500)}v=function(){var s,e=t.createElement(f);return e.src=g,s=n[r],!s&&""!==s||"undefined"==e[r]||(e[r]=s),e.onload=w,e.onerror=E,e.onreadystatechange=function(t,n){"loaded"!==e.readyState&&"complete"!==e.readyState||w(0,n)},e}(),n.ld<0?t.getElementsByTagName("head")[0].appendChild(v):setTimeout(function(){t.getElementsByTagName(f)[0].parentNode.appendChild(v)},n.ld||0)}try{i.cookie=t.cookie}catch{}function _(e){for(;e.length;)!function(e){i[e]=function(){var t=arguments;k||i.queue.push(function(){i[e].apply(i,t)})}}(e.pop())}var h="track",O="TrackPage",x="TrackEvent";return _([h+"Event",h+"PageView",h+"Exception",h+"Trace",h+"DependencyData",h+"Metric",h+"PageViewPerformance","start"+O,"stop"+O,"start"+x,"stop"+x,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),i.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},C=(s.extensionConfig||{}).ApplicationInsightsAnalytics||{},!0!==s[d]&&!0!==C[d]&&(p="onerror",_(["_"+p]),j=e[p],e[p]=function(e,t,n,s,o){var a=j&&j(e,t,n,s,o);return!0!==a&&i["_"+p]({message:e,url:t,lineNumber:n,columnNumber:s,error:o}),a},s.autoExceptionInstrumented=!0),i}(n.cfg);function p(){n.onInit&&n.onInit(s)}(e[i]=s).queue&&0===s.queue.length?(s.queue.push(p),s.trackPageView({})):p()}(window,document,{src:"https://js.monitor.azure.com/scripts/b/ai.2.min.js",crossOrigin:"anonymous",cfg:{connectionString:"InstrumentationKey=90cb325b-804c-43a9-97dd-9f34e5a0be01;IngestionEndpoint=https://westeurope-5.in.applicationinsights.azure.com/;LiveEndpoint=https://westeurope.livediagnostics.monitor.azure.com/",autoTrackPageVisitTime:!0}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFQGR29JJQ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFQGR29JJQ",{anonymize_ip:!1})}</script><meta property="og:title" content="How to verify that ILogger logged an error?"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://martdegraaf.github.io/posts/verifylogged-with-xunit/"><meta property="og:site_name" content="Mart's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to verify that ILogger logged an error?"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://martdegraaf.github.io/posts/"},{"@type":"ListItem","position":2,"name":"How to verify that ILogger logged an error?","item":"https://martdegraaf.github.io/posts/verifylogged-with-xunit/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://martdegraaf.github.io/ accesskey=h title="Mart's blog (Alt + H)">Mart's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://martdegraaf.github.io/nl/ title=Nederlands aria-label=Nl>Nl</a></li></ul></div></div><ul id=menu><li><a href=https://martdegraaf.github.io/about title=About><span>About</span></a></li><li><a href=https://martdegraaf.github.io/archive title=Archive><span>Archive</span></a></li><li><a href=https://martdegraaf.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://martdegraaf.github.io/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>How to verify that ILogger logged an error?</h1></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>For a recent project, I wanted to create a test that verified that <code>LogError</code> was called.
Consider for example this piece of code below. The catch operation was added to swallow the exception of the delete action. We want to test this behavior but still would like to know if the <code>LogError</code> is being called.</p><h2 id=the-system-under-test>The system under test<a hidden class=anchor aria-hidden=true href=#the-system-under-test>#</a></h2><pre><code class=language-cs data-line-numbers data-ln-start-from=1>public async Task Delete(long sequenceNumber)
{
  _logger.LogInformation(&#34;Deleting `{sequenceNumber}`.&#34;, sequenceNumber);
  try
  {
    await _client.Delete(..);
    _logger.LogInformation(&#34;Delete completed `{sequenceNumber}`.&#34;, sequenceNumber);
  }
  catch (InvalidOperationException ex)
    when (ex.Message.Equals($&#34;The scheduled message with SequenceNumber = {sequenceNumber} is already being cancelled.&#34;))
  {
    _logger.LogError(ex, &#34;Already cancelled {sequenceNumber}.&#34;, sequenceNumber);
  }
}</code></pre><h2 id=verify-that-logerror-is-called>Verify that <code>LogError</code> is called<a hidden class=anchor aria-hidden=true href=#verify-that-logerror-is-called>#</a></h2><p>Have you ever tried to verify your <code>LogError</code> using xUnit? It does not seem to work out of the box as other FakeItEasy.
I tried this code for example, but it just would not work. The mock that throws the exception has been left out to keep the code sample small.</p><pre><code class=language-cs data-line-numbers data-ln-start-from=1>//Arrange
var logger = A.Fake&lt;ILogger&lt;SystemUnderTest&gt;&gt;();
var sut = new SystemUnderTest(logger);

//Act
await sut.Delete(1);

//Assert
A.CallTo(() =&gt; logger.LogError(A&lt;string&gt;.Ignored, A&lt;object[]&gt;.Ignored))
    .MustHaveHappenedOnceExactly();</code></pre><h2 id=the-loggerextensions-class>The LoggerExtensions class<a hidden class=anchor aria-hidden=true href=#the-loggerextensions-class>#</a></h2><p>The solution was right at hand because my coworker had already figured it out. Thanks, Marnix. Chekout his blog: <a href=https://alanta.nl/>Marnix&rsquo; blog</a>. Use the extension class as described below.</p><pre><code class=language-cs data-line-numbers data-ln-start-from=1>//Arrange
var logger = A.Fake&lt;ILogger&lt;SystemUnderTest&gt;&gt;();
var sut = new SystemUnderTest(logger);

//Act
await sut.Delete(1);

//Assert
logger.VerifyLogged(LogLevel.Information, &#34;Deleting 1&#34;);
logger.VerifyLogged(LogLevel.Error, &#34;Already cancelled 1&#34;);</code></pre><h3 id=loggerextensionscs>LoggerExtensions.cs<a hidden class=anchor aria-hidden=true href=#loggerextensionscs>#</a></h3><pre><code class=language-cs data-line-numbers data-ln-start-from=1>using FakeItEasy;
using Microsoft.Extensions.Logging;
using System;
using System.Linq;
using Xunit.Sdk;

namespace SomeCoolNamespace;
public static class LoggerExtensions
{
    public static void VerifyLogged&lt;T&gt;(this ILogger&lt;T&gt; logger, LogLevel level, string logMessage)
    {
        var (found, actualLevel, actualMessage) = logger.VerifyLog(logMessage);
        if (!found)
        {
            throw new XunitException($&#34;No log message found containing &#39;{logMessage}&#39; at any loglevel&#34;);
        }

        if (actualLevel != level)
        {
            throw new AssertActualExpectedException(
                $&#34;[{level}] {logMessage}&#34;, $&#34;[{actualLevel}] {actualMessage}&#34;,
                $&#34;Unexpected log level for log message&#34;);
        }
    }

    public static void VerifyNotLogged&lt;T&gt;(this ILogger&lt;T&gt; logger, LogLevel level, string logMessage)
    {
        var (found, actualLevel, actualMessage) = logger.VerifyLog(logMessage);
        if (found &amp;&amp; actualLevel == level)
        {
            throw new XunitException(
                @$&#34;Log message found containing &#39;{logMessage}&#39;
                    at level {level}{Environment.NewLine}Message: {actualMessage}&#34;);
        }
    }

    public static void VerifyNotLoggedAtLevel&lt;T&gt;(this ILogger&lt;T&gt; logger, LogLevel level)
    {
        var call = Fake.GetCalls(logger)
            .FirstOrDefault(call =&gt; (LogLevel?)call.Arguments[0] == level);

        if (call != null)
        {
            throw new XunitException(
                @$&#34;Log message found at level {level}{Environment.NewLine}
                    Message: {call.Arguments[2]}&#34;);
        }
    }
    public static void VerifyLoggedAtLevel&lt;T&gt;(this ILogger&lt;T&gt; logger, LogLevel level)
    {
        var found = Fake.GetCalls(logger)
            .Any(call =&gt; (LogLevel?)call.Arguments[0] == level);

        if (found)
        {
            throw new XunitException($&#34;No log message found at level {level}&#34;);
        }
    }

    private static (bool found, LogLevel? level, string? message) VerifyLog&lt;T&gt;(this ILogger&lt;T&gt; logger, string message)
    {
        var call = Fake.GetCalls(logger)
            .FirstOrDefault(call =&gt; call.Arguments[2].ToString()
            .Contains(message, StringComparison.OrdinalIgnoreCase));

        return (call != null, (LogLevel?)call?.Arguments[0], call?.Arguments[2].ToString());
    }
}</code></pre><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Using this class you will be able to test your logging with Xunit and FakeItEasy.</p></div></main><footer class=footer><span>Mart de Graaf</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>